
<!DOCTYPE html>
<html style="height: 95%;">
<head>
	
	<title>Every Cold Atoms Experiment</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
	<script src="../json_data.js"></script>
	<script src="svg-icon.js"></script>
	<script src="OverlappingMarkerSpiderfier/oms.min.js"></script>
	
</head>
<body style="height: 100%;">

<h1 style="margin: auto; text-align: center;">Every Cold Atoms Experiment in the World</h1>

<div id="mapid" style="width: 100%; height: 50%;"></div>
<script>

	/* In the first edition. Spiderify will be on click, not on hover. 
	Programify all, this is too hard to make.
	
	If mouseover, mouseout event jih moram se unbindat in click.
	Za vsak slucaj verjetno najbolje vsakic vseh 250 markerjev bindat-unbindat.
		
	Maybe still best if disable hover. Pa se na mobile bo delal. Deal!
	
	// todo pri scrollable leaflet remove border.
	
	todo remove layer control. Make layergroups manually, with buttons on the bottom.
	Select exp, exp/theory, theory
	*and* which_atom
	and wether or not to include undefined.
	In se usakic ceu map, useh 250 markerjev, updata.
	
	*/

	var mymap = L.map('mapid').setView([0, 0], 0);

	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
			'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
		id: 'mapbox.streets',
		//layers: [layer1]
	}).addTo(mymap);

	var oms = new OverlappingMarkerSpiderfier(mymap, {keepSpiderfied: true});
    var popup = new L.Popup({closeButton: true, offset: new L.Point(0.5, -24), maxHeight:170, autoPan:false});
	// the offset must be for better position of the popup.
	oms.addListener('click', function(marker) {
	  popup.setContent(marker.desc);
	  popup.setLatLng(marker.getLatLng());
	  mymap.openPopup(popup);
	  marker.off('mouseout'); // this works, but it works for all eternity
	  // on any mouseover of any (other!) marker, this should reset. Also on any click on any marker.
	  console.log('Click');
	});
	oms.addListener('unspiderfy', function(markers) {
	  //mymap.closePopup();
	  console.log('Unspiderify');
	});
	
	oms.addListener('spiderfy', function(markers) {
	  mymap.closePopup();
	  console.log('Spiderify');
	});
	oms.addListener('mouseover', function(marker) {
	  popup.setContent(marker.desc);
	  popup.setLatLng(marker.getLatLng());
	  mymap.openPopup(popup);
	});
	
	function set_all_mouseout_events(marker){
		for (var i = 0; i < data.length; i++){
			if (markers[i] == marker){
				console.log('Equal');
			} else {
				markers[i].on('mouseout', function(e){ mymap.closePopup(); });
			}
		}
	}
	
	var markers = [];
	var layer_exp = [];
	var layer_theor = [];
	var layer_exp_theor = [];
	var layer_else = [];
	
	for (var i = 0; i < data.length; i++){
		var cmarker = new L.Marker.SVGMarker(
			[data[i]['lat'], data[i]['long']], { iconOptions: { color: "rgb(0,0,100)" }}
			);
		markers.push(cmarker) ;
		markers[i].desc = data[i]['desc']
		switch (data[i]['exp_theor']) {
			case "Exp":
				layer_exp.push(markers[i]);
				break;
			case "Theory":
				layer_theor.push(markers[i]);
				break;
			case "Exp/Theory":
				layer_exp_theor.push(markers[i]);
				break;
			default:
				layer_else.push(markers[i]);
				break;
		}
		
		mymap.addLayer(markers[i]);
		oms.addMarker(markers[i]);
		markers[i].on('mouseover', function(event){
			marker = event.target;
			//console.log(marker);
			popup.setContent(marker.desc);
			popup.setLatLng(marker.getLatLng());
			mymap.openPopup(popup);
			//set_all_mouseout_events(marker); // Obsolete. See mymap.on('popupclose'
		});
		markers[i].on('mouseout', function(e){ mymap.closePopup(); });
	}
	
	mymap.on('popupclose', function(e) {
		// Todo speedup. Only re-bind the last marker, not all of them.
		set_all_mouseout_events({});
	})
	
	mymap.on('layeradd', function(layer, layername){
		//console.log('layername', layername, layer);
		//console.log('Layer added', layer, layer.layer.options);
		if (typeof layer.layer.options != "undefined" && layer.layer.options.name != null)
			//console.log('Layer added', layer, layer.layer.options.name);
			console.log('Layer added', layer.layer.options.name);
	});
	mymap.on('layerremove ', function(layer, layername){
		if (typeof layer.layer.options != "undefined" && layer.layer.options.name != null)
			//console.log('Layer removed', layer, layer.layer.options.name);
			console.log('Layer removed', layer.layer.options.name);
	});
	
	
	var layer_exp = L.layerGroup(layer_exp, {name:'layer_exp'}).addTo(mymap);
	var layer_theor = L.layerGroup(layer_theor, {name:'layer_theor'}).addTo(mymap);
	var layer_exp_theor = L.layerGroup(layer_exp_theor, {name:'layer_exp_theor'}).addTo(mymap);
	var layer_else = L.layerGroup(layer_else, {name:'layer_else'}).addTo(mymap);
	
	var overlayMaps = {
		"Exp": layer_exp,
		"Exp+Theor": layer_exp_theor,
		"Theor": layer_theor,
		"Else": layer_else
	};
	
	layers_control = L.control.layers(null, overlayMaps).addTo(mymap);
	
/*
var marker0 = new L.Marker.SVGMarker([54.77525, -1.584852], { iconOptions: { color: "rgb(0,0,100)" }});
marker0.desc = '<a href="http://massey.dur.ac.uk/csa/research.html"><b>Adams group</b></a><br />Durham, United Kingdom';
mymap.addLayer(marker0);
oms.addMarker(marker0);
marker0.on('mouseover', function(e){
    popup.setContent(marker0.desc);
    popup.setLatLng(marker0.getLatLng());
    mymap.openPopup(popup);
});    marker0.on('mouseout', function(e){ mymap.closePopup(); });
var marker1 = new L.Marker.SVGMarker([32.7614296, 35.0195184], { iconOptions: { color: "rgb(0,0,100)" }});
marker1.desc = '<a href="http://hctpa.haifa.ac.il/index.php/current-members/10-members/current-members/5-prof-ofir-alon"><b>Alon group</b></a><br />University of Haifa, Israel';
mymap.addLayer(marker1);
oms.addMarker(marker1);
marker1.on('mouseover', function(e){
    popup.setContent(marker1.desc);
    popup.setLatLng(marker1.getLatLng());
    mymap.openPopup(popup);
});    marker1.on('mouseout', function(e){ mymap.closePopup(); });
var marker2 = new L.Marker.SVGMarker([32.2318851, -110.9501094], { iconOptions: { color: "rgb(0,0,100)" }});
marker2.desc = '<a href="http://www.optics.arizona.edu/Anderson/default.htm"><b>Anderson group</b></a><br />University of Arizona, United States';
mymap.addLayer(marker2);
oms.addMarker(marker2);
marker2.on('mouseover', function(e){
    popup.setContent(marker2.desc);
    popup.setLatLng(marker2.getLatLng());
    mymap.openPopup(popup);
});    marker2.on('mouseout', function(e){ mymap.closePopup(); });
*/	
	
	
	
	
	/*
	var marker0 = new L.marker([51.5, -0.09]); //.openPopup();
	marker0.desc = "<b>Hello world!</b><br />I am a popup.";
	var marker2 = new L.Marker.SVGMarker([51.5, -1.09], { iconOptions: { color: "rgb(0,0,100)" }})
	marker2.desc = "<b>Hello world2!</b><br />I am a popup.";
	mymap.addLayer(marker0);
	mymap.addLayer(marker2);
	oms.addMarker(marker0);
	oms.addMarker(marker2);
	*/
	
	//var marker1 = new L.Marker([51.5, -1.09]).bindPopup("<b>Hello world2!</b><br />I am a popup.");
	
	/*for (var i = 0; i < window.mapData.length; i ++) {
	  var datum = window.mapData[i];
	  var loc = new L.LatLng(datum.lat, datum.lon);
	  var marker = new L.Marker(loc);
	  marker.desc = datum.d;
	  mymap.addLayer(marker);
	  oms.addMarker(marker);  // <-- here
	}*/

	



</script>



</body>
</html>
